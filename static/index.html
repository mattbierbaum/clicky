<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="jquery.flot.js"></script>
<link rel="stylesheet" type="text/css" href="clicky.css">

<title> Clicky </title>

<script type="text/javascript">
$(document).ready(function() { openWS(); });

function KeyboardController(keys, repeat) {
    var timers = {};

    document.onkeydown= function(event) {
        var key= (event || window.event).keyCode;
        if (!(key in keys))
            return true;
        if (!(key in timers)) {
            timers[key]= null;
            keys[key]();
            if (repeat!==0)
                timers[key]= setInterval(keys[key], repeat);
        }
        return false;
    };

    document.onkeyup= function(event) {
        var key= (event || window.event).keyCode;
        if (key in timers) {
            if (timers[key]!==null)
            clearInterval(timers[key]);
            delete timers[key];
        }
    };

    window.onblur= function() {
        for (key in timers)
        if (timers[key]!==null)
            clearInterval(timers[key]);
        timers= {};
    };
};

KeyboardController({
    37: function() { sendpt("l"); },
    38: function() { sendpt("u"); },
    39: function() { sendpt("r"); },
    40: function() { sendpt("d"); }
}, 200);

// let's keep track of the data by the following:
// curr -> where the dot is
// points -> array of all points not current
// datasets -> array of datasets only build in the display

var host = window.location.hostname;
var port = "8000";
var points = new Array();
var cx = 0;
var cy = 0;
var time = 0;

var wsout;
var wswin;
var wsin;

function sendpt(c){
    wsin.send(c);
}

// get rid of old data as appropriate
function trimpoints(){
    var newpts = new Array();
    for (i=0; i<points.length; i++){
        var pt = points[i];
        var tx = pt[1];
        var ty = pt[2];
        if (Math.abs(tx-cx) <= 6 && Math.abs(ty-cy) <= 6)
            newpts.push(pt);
    }
    points = newpts;
}

function openWS(){
    if (wswin === undefined || wswin.readyState === undefined || wswin.readyState > 1) {
        wswin = new WebSocket("ws://" + host +":"+ port + "/window");
        wswin.onmessage = function(evt) {
            var data = $.parseJSON(evt.data);

            // append the new window, making sure its in time order
            for (i=0; i<data.length; i++)
                points.push(data[i]);
            points.sort(function(a,b){return a[0]-b[0];});

            draw();
        }
    }
    if (wsout === undefined || wsout.readyState === undefined || wsout.readyState > 1) {
        wsout = new WebSocket("ws://" + host +":"+ port + "/out");
        wsout.onmessage = function(evt) {
            var data = $.parseJSON(evt.data);
            time = data[0]
            cx = data[1];
            cy = data[2];

            // we've moved, get rid of old data so as not to bloat
            trimpoints();
            points.push([time, cx, cy]);
            draw();
        }
    }
    if (wsin === undefined || wsin.readyState === undefined || wsin.readyState > 1) {
        wsin = new WebSocket("ws://" + host +":"+ port + "/in");
    }
}
 
function draw(){
    var datasets = [];
    var i=0;
    for (i=0; i<points.length-1; i++){
        prev = points[i];
        next = points[i+1];
        if (prev[0] == (next[0] - 1))
            datasets.push({  data: [[prev[1],prev[2]], [next[1],next[2]]] ,  points: { radius: 2 },  color: 'blue'  });
    }
    ntl = points[i];
	datasets.push({ data: [[ntl[1],ntl[2]],[cx,cy]], points: { radius: 2 },  color: 'blue'  });
	datasets.push({ label: "current" , data: [[cx,cy]], color: "red", points: {show: true, radius: 5, fill: true, fillColor: '#FF9999' } } );

	var xticks = [];
    var yticks = [];
    for (var i=0; i < 10; i++ ){
        xticks.push( [cx-5 + i, "" ] );
        yticks.push( [cy-5 + i, "" ] );
    }

    $.plot($("#placeholder"),  
	    datasets , 
	    {
	        series: { lines: { show: true } , points: { show: true }},
            lines:  { show: true},
            points: { show: true  },
            xaxis:  { show: true, min: cx-5, max: cx+5 , ticks: xticks},
            yaxis:  { show: true, min: cy-5, max: cy+5 , ticks: yticks},
            grid:   { show: true, backgroundColor: { colors: ["#FFF", "#DDD"] } },
            legend: false
        }
    );
}


</script>
</head>


<center>
<table border='0'><tr>
<td><center><div id="placeholder" style="width:540px;height:540px;"></div></center></td>
<td><center>

<h1>Clicky</h1><br/>
<p> Say hello to Clicky, an experiment in collective motion.  
<br> Explore.  Use arrow keys or buttons.  
<br> Everyone has equal and simultaneous control of Clicky 
</p>

<form action="">
<table >
<input name='direction' type="button" value="U" onClick="sendpt('u');" class="btn btn-large btn-primary" > <br />
<input name='direction' type="button" value="L" onClick="sendpt('l');" class="btn btn-large btn-primary" >
<input name='direction' type="button" value="R" onClick="sendpt('r');" class="btn btn-large btn-primary" > <br />
<input name='direction' type="button" value="D" onClick="sendpt('d');" class="btn btn-large btn-primary" >
</table>
</form>

</center></td>
</tr></table>

</center>
<div id='status'></div>
</body>
</html>
